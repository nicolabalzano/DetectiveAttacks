import { navigateToThreats } from "../handle_routing_threats/HandleRoutingThreats.jsx"
import { fetchDataCVEAPI } from "../api/fetchAPI.jsx"
import { fetchDataCWEAPI } from "../api/fetchAPI.jsx"

const VulnerabilityMapping = () => {

    
    const handleClickNewCVWE = () => {
        const div_blur = document.getElementById('blur-div')
        if (div_blur && !div_blur.classList.contains('d-none')) {
            div_blur.classList.add('d-none')
        }
        else {
            div_blur.classList.remove('d-none')
        }
    }

    const handleSubmitNewMapping = (e) => {
        e.preventDefault();
        console.log(document.getElementById('insert_cve_cwe').value);

        // CHECK IF VULNERABILITY EXISTS
        let vulnerability = false;
        fetchDataCVEAPI().then((dataCVE) => {
            if(Object.keys(dataCVE).length === 0) {
                fetchDataCWEAPI().then((dataCWE) => {
                    if(Object.keys(dataCWE).length === 0) {
                        alert('CVE/CWE not found')
                    }
                    else
                        vulnerability = true;
                })
            }
            else 
                vulnerability = true;
        })

        // NAVIGATE TO THREATS PAGE IF VULNERABILITY EXISTS
        if(Object.keys(vulnerability).length !== 0) 
            navigateToThreats(document.getElementById('insert_cve_cwe').value, vulnerability)        
    }

    return (
        <>
            <button type='button'
                className='btn btn-primary position position-fixed bottom-0 end-0 mb-4 me-4 px-4'
                onClick={handleClickNewCVWE}>
                New CVE/CWE Mapping
            </button>

            {/* BLUR BACKGROUND */}
            <div
                id='blur-div'
                className='d-flex flex-column justify-content-center d-none position-absolute top-50 start-50 translate-middle w-100 h-100 z-2 bg-blur d-flex flex-column justify-content-center align-items-center'
            >
                <div onClick={handleClickNewCVWE} className=' position-absolute top-50 start-50 translate-middle w-100 h-100 z-2'></div>

                {/* INSERT NEW CVE CWE TO MAP */}
                <div className="position-absolute top-50 start-50 translate-middle w-75 bg-mapping regular-lg rounded z-3">
                    <p className='text-center display-6 fw-semibold text-uppercase mb-5'>
                        Insert the CVE or CWE id to know the related attack pattern
                    </p>
                    <form onSubmit={handleSubmitNewMapping}>
                        <div className="input-group flex-nowrap px-5 mt-5 w-75 mx-auto d-flex justify-content-center">
                            <input type="text" id='insert_cve_cwe' className="form-control text-uppercase" pattern="^(cve|cwe|CVE|CWE)-\d+-\d+$"
                                placeholder="e.g. Insert CVE-ID or CWE-ID" aria-label="text" aria-describedby="addon-wrapping" />
                        </div>
                        <div className="d-flex justify-content-center mt-5">
                            <button type="submit" className='btn btn-primary px-4 fs-5'>Search related Attack Patterns</button>
                        </div>
                    </form>
                </div>
            </div>
        </>
    )
}

export default VulnerabilityMapping