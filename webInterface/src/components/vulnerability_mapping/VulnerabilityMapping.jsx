import { navigateToThreats } from "../handle_routing_threats/HandleRoutingThreats.jsx"
import { fetchDataCVEAPI } from "../api/fetchAPI.jsx"
import { fetchDataCWEAPI } from "../api/fetchAPI.jsx"
import { useState } from "react"

const VulnerabilityMapping = () => {

    const [inputValue, setInputValue] = useState('');

    const handleInputChange = (event) => {
        setInputValue(event.target.value);
    };

    const handleClickNewCVWE = () => {
        const div_blur = document.getElementById('blur-div')
        if (div_blur && !div_blur.classList.contains('d-none')) {
            div_blur.classList.add('d-none')
        }
        else {
            div_blur.classList.remove('d-none')
        }
    }

    const handleSubmitNewMapping = (e) => {
        e.preventDefault();

        // CHECK IF VULNERABILITY EXISTS
        let response = ''
        let vulnerability = ''
        if (inputValue.startsWith('CVE') || inputValue.startsWith('cve')){
            fetchDataCVEAPI(inputValue).then((dataCVE) => {
                response = dataCVE.data
                // NAVIGATE TO THREATS PAGE IF VULNERABILITY EXISTS
                if(Object.keys(response).length > 0) 
                    navigateToThreats(inputValue, vulnerability)
            })
            vulnerability = 'CVE'
        } 
        else if (inputValue.startsWith('CWE') || inputValue.startsWith('cwe')){
            fetchDataCWEAPI(inputValue).then((dataCWE) => {
                response = dataCWE.data
                // NAVIGATE TO THREATS PAGE IF VULNERABILITY EXISTS
                if(Object.keys(response).length > 0) 
                    navigateToThreats(inputValue, vulnerability)
            })
            vulnerability = 'CWE'
        }        
    }

    return (
        <>
            <button type='button'
                className='btn btn-primary position position-fixed bottom-0 end-0 mb-4 me-4 px-4'
                onClick={handleClickNewCVWE}>
                New CVE/CWE Mapping
            </button>

            {/* BLUR BACKGROUND */}
            <div
                id='blur-div'
                className='d-flex flex-column justify-content-center d-none position-absolute top-50 start-50 translate-middle w-100 h-100 z-2 bg-blur d-flex flex-column justify-content-center align-items-center'
            >
                <div onClick={handleClickNewCVWE} className=' position-absolute top-50 start-50 translate-middle w-100 h-100 z-2'></div>

                {/* INSERT NEW CVE CWE TO MAP */}
                <div className="position-absolute top-50 start-50 translate-middle w-75 bg-mapping regular-lg rounded z-3">
                    <p className='text-center display-6 fw-semibold text-uppercase mb-5'>
                        Insert the CVE or CWE id to know the related attack patterns
                    </p>
                    <form onSubmit={handleSubmitNewMapping}>
                        <div className="input-group flex-nowrap px-5 mt-5 w-75 mx-auto d-flex justify-content-center">
                            <input type="text" id='insert_cve_cwe' className="form-control text-uppercase" onChange={handleInputChange} pattern="^(cve|cwe|CVE|CWE)-\d+(-\d+)?$"
                                placeholder="e.g. Insert CVE-ID or CWE-ID" aria-label="text" aria-describedby="addon-wrapping" />
                        </div>
                        <div className="d-flex justify-content-center mt-5">
                            <button type="submit" className='btn btn-primary px-4 fs-5'>Search related Attack Patterns</button>
                        </div>
                    </form>
                </div>
            </div>
        </>
    )
}

export default VulnerabilityMapping